---
layout: post
title: SSL协议详解
category: 信息安全
tags: SSL
description: 关于SSL的一个理解，主要是了解他的证书认证过程
---
>最近由于做信安，涉及到了服务器端和客户端的一个认证过程，所以会用到SSL的鉴别功能，之前由于没有接触过这些方面的东西，所以也是便学习便总结下。

## 前期资料

### 1.密码学相关概念
* __密码学(cryptography)__：目的是通过将信息编码使其不可读，从而达到安全性。
* __明文(plain text)__：发送人、接受人和任何访问消息的人都能理解的消息。
* __密文(cipher text)__：明文消息经过某种编码后，得到密文消息。
* __加密(encryption)__：将明文消息变成密文消息。
* __解密(decryption)__：将密文消息变成明文消息。
* __算法__：取一个输入文本，产生一个输出文本。
* __加密算法__：发送方进行加密的算法。
* __解密算法__：接收方进行解密的算法。
* __密钥(key)__：只有发送方和接收方理解的消息
* __对称密钥加密(Symmetric Key Cryptography)__：加密与解密使用相同密钥。
* __非对称密钥加密(Asymmetric Key Cryptography)__：加密与解密使用不同密钥。

### 2.对称加密（密钥加密）
加密和解密都使用同一个密钥，速度很快，效率高，通常在消息发送方需要大量数据时使用。对称加密也叫做密钥加密。

发送和接受方必须实现商定好密钥，如果密钥传输的过程不安全，那么很容易破解，且密钥的管理十分的麻烦。

对称加密算法：DES（Data Encryption Standard）、3DES、AES（Advanced Encryption Standard，支持128、192、256、512位密钥的加密）、Blowfish 、SM4。

### 3.非对称加密（公钥加密）
需要两个密钥来进行加密和解密，这两个密钥是公钥public key，简称公钥）和私有密钥（private key，简称私钥），每个用户拥用一对密钥加密：公钥和私钥。

公钥加密，私钥解密；私钥加密，公钥解密。

非对称加密的缺点是加密和解密花费时间长、速度慢，只适合对少量数据进行加密。

在非对称加密中使用的主要算法有：RSA、Elgamal、背包算法、Rabin、D-H、ECC（椭圆曲线加密算法）等。

某一个用户用其私钥加密，其他用户用其公钥解密，实现数字签名的作用，公钥加密的另一个作用是实现密钥交换。比较著名的Diffie-Hellman密钥交换算法原理如下：  

```
（1）Alice与Bob确定两个大素数n和g，这两个数不用保密  
（2）Alice选择另一个大随机数x，并计算A如下：A=g^x mod n  
（3）Alice将A发给Bob  
（4）Bob选择另一个大随机数y，并计算B如下：B=g^y mod n  
（5）Bob将B发给Alice  
（6）计算秘密密钥K1如下：K1=B^x mod n  
（7）计算秘密密钥K2如下：K2=A^y mod n  
 K1=K2，因此Alice和Bob可以用其进行加解密  
```
关于Diffie–Hellman密钥交换算法的详细说明，可以参考另一篇[文章](https://zh.wikipedia.org/wiki/%E8%BF%AA%E8%8F%B2-%E8%B5%AB%E7%88%BE%E6%9B%BC%E5%AF%86%E9%91%B0%E4%BA%A4%E6%8F%9B) 。

### 4.Hash算法
Hash，一般翻译做“散列”，也有直接音译为“哈希”的，就是把任意长度的输入（又叫做预映射， pre-image），通过散列算法，变换成固定长度的输出，该输出就是散列值。这种转换是一种压缩映射，也就是，散列值的空间通常远小于输入的空间，不同的输入可能会散列成相同的输出，而不可能从散列值来唯一的确定输入值。简单的说就是一种将任意长度的消息压缩到某一固定长度的消息摘要的函数。

此外，好的散列算法使得构造两个独立的有相同散列的输入不能通过计算方法实现。典型的散列算法包括MD2、MD4、MD5、SHA-1和SM3。散列算法也被称为散列函数。散列算法的算法就是争取一个萝卜一个坑的原则。

在信息安全技术中，经常需要验证消息的完整性，散列（Hash）函数提供了这一服务，它对不同长度的输入消息，产生固定长度的输出。这个固定长度的输出称为原输入消息的“散列”或“消息摘要”（Message digest）。

###  5.数字证书：
数字证书其实就是一个小的计算机文件，其作用类似于我们的身份证、护照，用于证明身份，在SSL中，使用数字证书来证明自己的身份，而不是伪造的。

## SSL详解

### 1.SSL介绍
SSL(Secure Sockets Layer 安全套接层),及其继任者传输层安全（Transport Layer Security，TLS）是为网络通信提供安全及数据完整性的一种安全协议。TLS与SSL在传输层对网络连接进行加密。

　　　　　　　　　　　![2016-6-29-1](/public/img/2016-6-29-1.png)

当前版本为3.0。它已被广泛地用于Web浏览器与服务器之间的身份认证和加密数据传输。

SSL协议位于TCP/IP协议与各种应用层协议之间，为数据通讯提供安全支持。SSL协议可分为两层： SSL记录协议（SSL Record Protocol）：它建立在可靠的传输协议（如TCP）之上，为高层协议提供数据封装、压缩、加密等基本功能的支持。 SSL握手协议（SSL Handshake Protocol）：它建立在SSL记录协议之上，用于在实际的数据传输开始前，通讯双方进行身份认证、协商加密算法、交换加密密钥等。

### 2.SSL的三个特性
* 保密：在握手协议中定义了会话密钥后，所有的消息都被加密。
* 鉴别：可选的客户端认证，和强制的服务器端认证。
* 完整性：传送的消息包括消息完整性检查（使用MAC）。

### 3.SSL工作原理
* 握手协议（Handshake protocol）
* 记录协议（Record protocol）

#### a.握手协议（Handshake protocol）
握手协议的四个阶段：

　　　　　　　　　　　　  　　           ![2016-6-29-2](/public/img/2016-6-29-2.png)  

握手协议是客户机和服务器用SSL连接通信时使用的第一个子协议，握手协议包括客户机与服务器之间的一系列消息。SSL中最复杂的协议就是握手协议。该协议允许服务器和客户机相互验证，协商加密和MAC算法以及保密密钥，用来保护在SSL记录中发送的数据。握手协议是在应用程序的数据传输之前使用的。  

__阶段一：建立连接，确定方法__

　　　　　　　　　　　　　![2016-6-29-3](/public/img/2016-6-29-3.png)

首先客户机向服务器发出client hello消息并等待服务器响应，随后服务器向客户机返回server hello消息，对client hello消息中的信息进行确认。
ClientHello 客户发送CilentHello信息，包含如下内容：  

* 客户端的SSL协议版本号
* 一个用于生成主秘密的随机数。
* 客户端可以支持的密码套件列表。
* 客户端可以支持的压缩算法列表。

　　密码套件格式：每个套件都以“SSL”开头，紧跟着的是密钥交换算法。用“With”这个词把密钥交换算法、加密算法、散列算法分开，例如：SSL_DHE_RSA_WITH_DES_CBC_SHA, 表示把DHE_RSA(带有RSA数字签名的Diffie-HellMan)定义为密钥交换算法；把DES_CBC定义为加密算法；把SHA定义为散列算法。

 ServerHello服务器用ServerHello信息应答客户，包括下列内容

* 确定的SSL版本号。
* 一个用于生成主秘密的随机数。（客户端一个、服务端一个）
* 从客户端的密码套件列表中选择的一个密码套件
* 从客户端的压缩方法的列表中选择的压缩方法

这个阶段之后，客户端服务端知道了下列内容：

* SSL版本
* 密钥交换、信息验证和加密算法
* 压缩方法
* 有关密钥生成的两个随机数。

__阶段二：服务器身份鉴别密钥交换__

　　　　　　　　　   　![2016-6-29-4](/public/img/2016-6-29-4.png)

服务器启动SSL握手第2阶段，是本阶段所有消息的唯一发送方，客户机是所有消息的唯一接收方。该阶段分为4步：

__（a）__ 证书：服务器将数字证书和到根CA整个链发给客户端，使客户端能用服务器证书中的服务器公钥认证服务器。  
__（b）__ 服务器密钥交换：服务器的公钥，这里视密钥交换算法而定。  
__（c）__ 证书请求：服务端可能会要求客户自身进行验证。  
__（d）__ 服务器握手完成：第二阶段的结束，第三阶段开始的信号。

__阶段三：客户机鉴别与密钥交换__

　　　　　　　　　　![2016-6-29-5](/public/img/2016-6-29-5.png)

客户机启动SSL握手第3阶段，客户端是本阶段所有消息的唯一发送方，服务器是所有消息的唯一接收方。该阶段分为3步：  

__（a）__ 证书（可选）：为了对服务器证明自身，客户要发送一个证书信息，这是可选的，在IIS中可以配置强制客户端证书认证。  
__（b）__ 客户机密钥交换（Pre-master-secret）：这里客户端将预备主密钥通过服务器的公钥加密后发送给服务端。  
__（c）__ 证书验证（可选），对预备秘密和随机数进行签名，证明拥有（a）证书的公钥。

__阶段四：完成__

　　　　　　　![2016-6-29-6](/public/img/2016-6-29-6.png)

该阶段分为4步，前2个消息来自客户机，后2个消息来自服务器。

__（ａ）__ 客户端使用一系列加密运算将 pre-master secret 转化为 master secret，其中将派生出所有用于加密和消息认证的密钥。然后，客户端发出“更改密码规范” 消息将服务器转换为新协商的密码对。客户端发出的下一个消息（“未完成”的消息）为用此密码方法和密钥加密的第一条消息。  
__（ｂ）__  服务器以自己的“更改密码规范”和“已完成”消息响应。

 SSL 握手结束，且可以发送加密的应用程序数据。

#### b.记录协议（Record protocol）

 记录协议在客户机和服务器握手成功后使用，即客户机和服务器鉴别对方和确定安全信息交换使用的算法后，进入SSL记录协议，记录协议向SSL连接提供两个服务：

__（1）保密性__ ：使用握手协议定义的秘密密钥实现。

__（2）完整性__ ：握手协议定义了MAC，用于保证消息完整性

记录协议的过程：

　　　　　　　![2016-6-29-7](/public/img/2016-6-29-7.png)